name: Setup Server

on:
  workflow_dispatch:
    inputs:
      setup_type:
        description: "Type of setup to run"
        required: true
        type: choice
        options:
          - system
          - user
          - both
        default: "both"
      server_host:
        description: "Server IP address or hostname"
        required: true
        type: string
      server_user:
        description: "SSH user (e.g., root for system setup, developer for user setup)"
        required: true
        type: string
      server_port:
        description: "SSH port"
        required: false
        type: string
        default: "22"
      git_user_name:
        description: "Git user name (required for user setup)"
        required: false
        type: string
      git_user_email:
        description: "Git user email (required for user setup)"
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ inputs.server_port }} -H ${{ inputs.server_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} -o StrictHostKeyChecking=accept-new ${{ inputs.server_user }}@${{ inputs.server_host }} "echo 'SSH connection successful'"

      - name: Run System Setup
        if: inputs.setup_type == 'system' || inputs.setup_type == 'both'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} -o StrictHostKeyChecking=accept-new ${{ inputs.server_user }}@${{ inputs.server_host }} << 'ENDSSH'
            export REPO_OWNER="${{ github.repository_owner }}"
            export REPO_NAME="${{ github.event.repository.name }}"
            export REPO_BRANCH="${{ github.sha }}"
            bash -c "$(curl -sSL https://raw.githubusercontent.com/${{ github.repository }}/${{ github.sha }}/system/setup.sh)"
          ENDSSH

      - name: Run User Setup
        if: inputs.setup_type == 'user' || inputs.setup_type == 'both'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} -o StrictHostKeyChecking=accept-new ${{ inputs.server_user }}@${{ inputs.server_host }} << 'ENDSSH'
            export REPO_OWNER="${{ github.repository_owner }}"
            export REPO_NAME="${{ github.event.repository.name }}"
            export REPO_BRANCH="${{ github.sha }}"
            export GIT_USER_NAME="${{ inputs.git_user_name }}"
            export GIT_USER_EMAIL="${{ inputs.git_user_email }}"
            export NVM_VERSION="${{ vars.NVM_VERSION || 'v0.40.3' }}"
            export CODE_SERVER_PORT_START="${{ vars.CODE_SERVER_PORT_START || '8080' }}"
            export CODE_SERVER_PORT_END="${{ vars.CODE_SERVER_PORT_END || '8100' }}"
            bash -c "$(curl -sSL https://raw.githubusercontent.com/${{ github.repository }}/${{ github.sha }}/user/setup.sh)"
          ENDSSH
      - name: Enable code-server service
        if: inputs.setup_type == 'user' || inputs.setup_type == 'both'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} -o StrictHostKeyChecking=accept-new ${{ inputs.server_user }}@${{ inputs.server_host }} << 'ENDSSH'
            TARGET_USER="${{ inputs.server_user }}"
            if command -v sudo >/dev/null 2>&1; then
              sudo -n systemctl enable --now code-server@"$TARGET_USER" || echo "Skipping code-server enable (sudo password required)"
            else
              systemctl enable --now code-server@"$TARGET_USER" || echo "Skipping code-server enable (insufficient permissions)"
            fi
          ENDSSH
      - name: Collect user setup outputs
        if: inputs.setup_type == 'user' || inputs.setup_type == 'both'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} -o StrictHostKeyChecking=accept-new ${{ inputs.server_user }}@${{ inputs.server_host }} << 'ENDSSH'
            CONFIG_PATH="$HOME/.config/code-server/config.yaml"
            if [ -f "$CONFIG_PATH" ]; then
              echo "----- code-server config -----"
              cat "$CONFIG_PATH"
              echo "------------------------------"
            else
              echo "code-server config not found at $CONFIG_PATH"
            fi
            KEY_PATH="$HOME/.ssh/id_ed25519.pub"
            if [ -f "$KEY_PATH" ]; then
              echo "----- SSH public key -----"
              cat "$KEY_PATH"
              echo "--------------------------"
            else
              echo "SSH public key not found at $KEY_PATH"
            fi
          ENDSSH
      - name: Display Post-Setup Instructions
        if: inputs.setup_type == 'user' || inputs.setup_type == 'both'
        run: |
          echo "âœ… Setup completed successfully!"
          echo ""
          echo "ðŸ“‹ Review the workflow logs for code-server credentials and the generated SSH public key."
          echo "âš™ï¸ If code-server was not enabled automatically, ensure the target user has passwordless sudo access for systemctl."
          echo ""
          echo "ðŸ”‘ Remember to secure your server and manage access to the SSH private key."

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

name: Setup Server

on:
  workflow_dispatch:
    inputs:
      # Server Connection Settings
      server_host:
        description: "Server IP address or hostname"
        required: true
        type: string
      server_port:
        description: "SSH port"
        required: false
        type: string
        default: "22"
      # User Configuration
      target_user:
        description: "Target user to setup (will be created if doesn't exist)"
        required: true
        type: string
      make_user_sudo:
        description: "Grant user passwordless sudo privileges (applies to both new and existing users)"
        required: false
        type: boolean
        default: false
      ssh_public_key:
        description: "SSH public key to add to authorized_keys for the target user"
        required: false
        type: string
      # Setup Configuration
      setup_profile:
        description: "Setup profile to use"
        required: true
        type: choice
        options:
          - "Full Development Server"
          - "System Services Only"
          - "User Tools Only"
          - "Custom (use repository variables)"
        default: "Full Development Server"
      # Tool-Specific Settings
      git_user_name:
        description: "Git user name (required for user tools)"
        required: false
        type: string
      git_user_email:
        description: "Git user email (required for user tools)"
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine modules to install
        id: modules
        run: |
          PROFILE="${{ inputs.setup_profile }}"

          # Default all to false
          OPENSSH_UFW="false"
          PACKAGES="false"
          NGINX="false"
          CERTBOT="false"
          CODE_SERVER="false"
          POSTGRES="false"
          UV="false"
          NVM="false"
          REPOS="false"
          GIT_SSH="false"

          case "$PROFILE" in
            "Full Development Server")
              OPENSSH_UFW="true"
              PACKAGES="true"
              NGINX="true"
              CERTBOT="true"
              CODE_SERVER="true"
              POSTGRES="true"
              UV="true"
              NVM="true"
              REPOS="true"
              GIT_SSH="true"
              ;;
            "System Services Only")
              OPENSSH_UFW="true"
              PACKAGES="true"
              NGINX="true"
              CERTBOT="true"
              CODE_SERVER="true"
              POSTGRES="true"
              ;;
            "User Tools Only")
              UV="true"
              NVM="true"
              REPOS="true"
              GIT_SSH="true"
              ;;
            "Custom (use repository variables)")
              # Read from repository variables
              OPENSSH_UFW="${{ vars.SETUP_OPENSSH_UFW || 'false' }}"
              PACKAGES="${{ vars.SETUP_PACKAGES || 'false' }}"
              NGINX="${{ vars.SETUP_NGINX || 'false' }}"
              CERTBOT="${{ vars.SETUP_CERTBOT || 'false' }}"
              CODE_SERVER="${{ vars.SETUP_CODE_SERVER || 'false' }}"
              POSTGRES="${{ vars.SETUP_POSTGRES || 'false' }}"
              UV="${{ vars.SETUP_UV || 'false' }}"
              NVM="${{ vars.SETUP_NVM || 'false' }}"
              REPOS="${{ vars.SETUP_REPOS_DIR || 'false' }}"
              GIT_SSH="${{ vars.SETUP_GIT_SSH || 'false' }}"
              ;;
          esac

          echo "setup_openssh_ufw=$OPENSSH_UFW" >> $GITHUB_OUTPUT
          echo "setup_packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "setup_nginx=$NGINX" >> $GITHUB_OUTPUT
          echo "setup_certbot=$CERTBOT" >> $GITHUB_OUTPUT
          echo "setup_code_server=$CODE_SERVER" >> $GITHUB_OUTPUT
          echo "setup_postgres=$POSTGRES" >> $GITHUB_OUTPUT
          echo "setup_uv=$UV" >> $GITHUB_OUTPUT
          echo "setup_nvm=$NVM" >> $GITHUB_OUTPUT
          echo "setup_repos_dir=$REPOS" >> $GITHUB_OUTPUT
          echo "setup_git_ssh=$GIT_SSH" >> $GITHUB_OUTPUT

          echo "üìã Selected Profile: $PROFILE"
          echo "System Modules: openssh_ufw=$OPENSSH_UFW, packages=$PACKAGES, nginx=$NGINX, certbot=$CERTBOT, code_server=$CODE_SERVER, postgres=$POSTGRES"
          echo "User Modules: uv=$UV, nvm=$NVM, repos=$REPOS, git_ssh=$GIT_SSH"

      - name: Validate inputs
        id: validate
        run: |
          # Validate git inputs for git_ssh setup
          if [[ "${{ steps.modules.outputs.setup_git_ssh }}" == "true" ]]; then
            if [[ -z "${{ inputs.git_user_name }}" || -z "${{ inputs.git_user_email }}" ]]; then
              echo "‚ùå Error: git_user_name and git_user_email are required when Git/SSH setup is enabled"
              exit 1
            fi
            
            # Validate email format
            if [[ ! "${{ inputs.git_user_email }}" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
              echo "‚ùå Error: Invalid email format"
              exit 1
            fi
          fi

          # Check if any system modules are enabled
          if [[ "${{ steps.modules.outputs.setup_openssh_ufw }}" == "true" ]] || \
             [[ "${{ steps.modules.outputs.setup_packages }}" == "true" ]] || \
             [[ "${{ steps.modules.outputs.setup_nginx }}" == "true" ]] || \
             [[ "${{ steps.modules.outputs.setup_certbot }}" == "true" ]] || \
             [[ "${{ steps.modules.outputs.setup_code_server }}" == "true" ]] || \
             [[ "${{ steps.modules.outputs.setup_postgres }}" == "true" ]]; then
            echo "has_system_modules=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Note: System setup modules require SUDO_ACCESS_USER to be configured"
            if [[ -z "${{ secrets.SUDO_ACCESS_USER }}" ]]; then
              echo "‚ùå Error: SUDO_ACCESS_USER secret must be set for system operations"
              exit 1
            fi
          else
            echo "has_system_modules=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Use cat with heredoc to safely write the key
          cat > ~/.ssh/deploy_key <<'SSHKEY_EOF'
          ${{ secrets.SERVER_SSH_KEY }}
          SSHKEY_EOF

          # Ensure proper line ending
          echo "" >> ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Verify key format
          if ! ssh-keygen -l -f ~/.ssh/deploy_key >/dev/null 2>&1; then
            echo "‚ùå Error: Invalid SSH key format"
            exit 1
          fi

          ssh-keyscan -p ${{ inputs.server_port }} -H ${{ inputs.server_host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Test SSH connection
        run: |
          # Determine which user to connect as for system operations
          if [[ "${{ steps.validate.outputs.has_system_modules }}" == "true" ]]; then
            SSH_USER="${{ secrets.SUDO_ACCESS_USER }}"
          else
            SSH_USER="${{ inputs.target_user }}"
          fi

          if ! ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} -o ConnectTimeout=10 -o StrictHostKeyChecking=accept-new ${SSH_USER}@${{ inputs.server_host }} "echo 'SSH connection successful'"; then
            echo "‚ùå Failed to establish SSH connection"
            exit 1
          fi

      - name: Create or Update target user
        run: |
          # Connect as sudo user if system modules are enabled, otherwise as target user
          if [[ "${{ steps.validate.outputs.has_system_modules }}" == "true" ]]; then
            SSH_USER="${{ secrets.SUDO_ACCESS_USER }}"
          else
            SSH_USER="${{ inputs.target_user }}"
          fi

          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${SSH_USER}@${{ inputs.server_host }} bash <<'ENDSSH'
            set -e

            TARGET_USER="${{ inputs.target_user }}"
            MAKE_SUDO="${{ inputs.make_user_sudo }}"
            SSH_PUB_KEY="${{ inputs.ssh_public_key }}"

            run_as_sudo() {
              if [[ $EUID -eq 0 ]]; then
                "$@"
              elif command -v sudo >/dev/null 2>&1; then
                sudo "$@"
              else
                echo "‚ùå Error: Need root or sudo permissions"
                exit 1
              fi
            }

            # Check if user exists, create if not
            if id "$TARGET_USER" &>/dev/null; then
              echo "‚úÖ User $TARGET_USER already exists"
            else
              echo "üîß Creating user: $TARGET_USER"
              run_as_sudo useradd -m -s /bin/bash "$TARGET_USER"
              echo "‚úÖ User $TARGET_USER created successfully"
            fi

            # Grant sudo access if requested
            if [[ "$MAKE_SUDO" == "true" ]]; then
              echo "üîß Ensuring $TARGET_USER is a sudoer"
              run_as_sudo usermod -aG sudo "$TARGET_USER"
              # Enable passwordless sudo
              echo "$TARGET_USER ALL=(ALL) NOPASSWD:ALL" | run_as_sudo tee "/etc/sudoers.d/$TARGET_USER" > /dev/null
              run_as_sudo chmod 440 "/etc/sudoers.d/$TARGET_USER"
              echo "‚úÖ $TARGET_USER has sudo privileges"
            fi

            # Add SSH public key if provided
            if [[ -n "$SSH_PUB_KEY" ]]; then
              echo "üîë Adding SSH public key for $TARGET_USER"
              USER_HOME=$(eval echo ~$TARGET_USER)
              run_as_sudo mkdir -p "$USER_HOME/.ssh"
              # Add key only if it's not already there
              if ! run_as_sudo grep -qF "$SSH_PUB_KEY" "$USER_HOME/.ssh/authorized_keys" 2>/dev/null; then
                run_as_sudo bash -c "echo '$SSH_PUB_KEY' >> '$USER_HOME/.ssh/authorized_keys'"
                echo "‚úÖ Public key added"
              else
                echo "‚úÖ Public key already exists"
              fi
              run_as_sudo chmod 700 "$USER_HOME/.ssh"
              run_as_sudo chmod 600 "$USER_HOME/.ssh/authorized_keys"
              run_as_sudo chown -R "$TARGET_USER:$TARGET_USER" "$USER_HOME/.ssh"
            fi
          ENDSSH

      - name: Upload scripts to server
        run: |
          if [[ "${{ steps.validate.outputs.has_system_modules }}" == "true" ]]; then
            SSH_USER="${{ secrets.SUDO_ACCESS_USER }}"
          else
            SSH_USER="${{ inputs.target_user }}"
          fi

          scp -i ~/.ssh/deploy_key -P ${{ inputs.server_port }} \
            scripts/foundry-*.sh \
            ${SSH_USER}@${{ inputs.server_host }}:/tmp/

      - name: Initial system update
        if: steps.validate.outputs.has_system_modules == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${{ secrets.SUDO_ACCESS_USER }}@${{ inputs.server_host }} bash <<'ENDSSH'
            set -e
            echo "üîÑ Running apt-get update..."
            if [[ $EUID -eq 0 ]]; then
              DEBIAN_FRONTEND=noninteractive apt-get update -y
            elif command -v sudo >/dev/null 2>&1; then
              sudo DEBIAN_FRONTEND=noninteractive apt-get update -y
            else
              echo "‚ùå Error: Need root or sudo for system operations"
              exit 1
            fi
          ENDSSH

      - name: Setup OpenSSH and UFW
        if: steps.modules.outputs.setup_openssh_ufw == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${{ secrets.SUDO_ACCESS_USER }}@${{ inputs.server_host }} bash <<'ENDSSH'
            set -e
            echo "üöÄ Setting up OpenSSH and UFW..."
            if [[ $EUID -eq 0 ]]; then
              bash /tmp/foundry-openssh-ufw.sh
            elif command -v sudo >/dev/null 2>&1; then
              sudo bash /tmp/foundry-openssh-ufw.sh
            fi
            echo "‚úÖ OpenSSH and UFW setup completed"
          ENDSSH

      - name: Setup necessary packages
        if: steps.modules.outputs.setup_packages == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${{ secrets.SUDO_ACCESS_USER }}@${{ inputs.server_host }} bash <<'ENDSSH'
            set -e
            echo "üöÄ Installing necessary packages..."
            if [[ $EUID -eq 0 ]]; then
              bash /tmp/foundry-packages.sh
            elif command -v sudo >/dev/null 2>&1; then
              sudo bash /tmp/foundry-packages.sh
            fi
            echo "‚úÖ Necessary packages setup completed"
          ENDSSH

      - name: Setup Nginx
        if: steps.modules.outputs.setup_nginx == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${{ secrets.SUDO_ACCESS_USER }}@${{ inputs.server_host }} bash <<'ENDSSH'
            set -e
            echo "üöÄ Setting up Nginx..."
            if [[ $EUID -eq 0 ]]; then
              bash /tmp/foundry-nginx.sh
            elif command -v sudo >/dev/null 2>&1; then
              sudo bash /tmp/foundry-nginx.sh
            fi
            echo "‚úÖ Nginx setup completed"
          ENDSSH

      - name: Setup Certbot
        if: steps.modules.outputs.setup_certbot == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${{ secrets.SUDO_ACCESS_USER }}@${{ inputs.server_host }} bash <<'ENDSSH'
            set -e
            echo "üöÄ Setting up Certbot..."
            if [[ $EUID -eq 0 ]]; then
              bash /tmp/foundry-certbot.sh
            elif command -v sudo >/dev/null 2>&1; then
              sudo bash /tmp/foundry-certbot.sh
            fi
            echo "‚úÖ Certbot setup completed"
          ENDSSH

      - name: Setup PostgreSQL
        if: steps.modules.outputs.setup_postgres == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${{ secrets.SUDO_ACCESS_USER }}@${{ inputs.server_host }} bash <<'ENDSSH'
            set -e
            echo "üöÄ Setting up PostgreSQL..."
            if [[ $EUID -eq 0 ]]; then
              bash /tmp/foundry-postgres.sh
            elif command -v sudo >/dev/null 2>&1; then
              sudo bash /tmp/foundry-postgres.sh
            fi
            echo "‚úÖ PostgreSQL setup completed"
          ENDSSH

      - name: Setup Code Server (Install)
        if: steps.modules.outputs.setup_code_server == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${{ secrets.SUDO_ACCESS_USER }}@${{ inputs.server_host }} bash <<'ENDSSH'
            set -e
            
            echo "üöÄ Installing code-server system-wide..."
            if [[ $EUID -eq 0 ]]; then
              bash /tmp/foundry-code-server-install.sh
            elif command -v sudo >/dev/null 2>&1; then
              sudo bash /tmp/foundry-code-server-install.sh
            fi
            echo "‚úÖ Code-server installation completed"
          ENDSSH

      - name: Setup Code Server (Configure)
        if: steps.modules.outputs.setup_code_server == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${{ inputs.target_user }}@${{ inputs.server_host }} bash <<'ENDSSH'
            set -e
            
            export CODE_SERVER_PORT_START="${{ vars.CODE_SERVER_PORT_START || '8080' }}"
            export CODE_SERVER_PORT_END="${{ vars.CODE_SERVER_PORT_END || '8100' }}"
            
            echo "üöÄ Configuring code-server for user..."
            bash /tmp/foundry-code-server-config.sh
            echo "‚úÖ Code-server configuration completed"
          ENDSSH

      - name: Setup Code Server (Enable Service)
        if: steps.modules.outputs.setup_code_server == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${{ secrets.SUDO_ACCESS_USER }}@${{ inputs.server_host }} bash <<'ENDSSH'
            set -e
            
            export TARGET_USER="${{ inputs.target_user }}"
            
            echo "üöÄ Enabling code-server service..."
            if [[ $EUID -eq 0 ]]; then
              bash /tmp/foundry-code-server-service.sh
            elif command -v sudo >/dev/null 2>&1; then
              sudo TARGET_USER="$TARGET_USER" bash /tmp/foundry-code-server-service.sh
            fi
            echo "‚úÖ Code-server service enabled"
          ENDSSH

      - name: Setup uv Python manager
        if: steps.modules.outputs.setup_uv == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${{ inputs.target_user }}@${{ inputs.server_host }} bash <<'ENDSSH'
            set -e
            echo "üöÄ Setting up uv..."
            bash /tmp/foundry-uv.sh
            echo "‚úÖ uv setup completed"
          ENDSSH

      - name: Setup nvm Node.js manager
        if: steps.modules.outputs.setup_nvm == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${{ inputs.target_user }}@${{ inputs.server_host }} bash <<'ENDSSH'
            set -e
            export NVM_VERSION="${{ vars.NVM_VERSION || 'v0.40.3' }}"
            
            echo "üöÄ Setting up nvm..."
            bash /tmp/foundry-nvm.sh
            echo "‚úÖ nvm setup completed"
          ENDSSH

      - name: Setup repos directory
        if: steps.modules.outputs.setup_repos_dir == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${{ inputs.target_user }}@${{ inputs.server_host }} bash <<'ENDSSH'
            set -e
            echo "üöÄ Setting up repos directory..."
            bash /tmp/foundry-repos.sh
            echo "‚úÖ repos directory setup completed"
          ENDSSH

      - name: Setup Git and SSH
        if: steps.modules.outputs.setup_git_ssh == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${{ inputs.target_user }}@${{ inputs.server_host }} bash <<'ENDSSH'
            set -e
            export GIT_USER_NAME="${{ inputs.git_user_name }}"
            export GIT_USER_EMAIL="${{ inputs.git_user_email }}"
            
            echo "üöÄ Setting up Git and SSH..."
            bash /tmp/foundry-git-ssh.sh
            echo "‚úÖ Git and SSH setup completed"
          ENDSSH

      - name: Retrieve setup credentials
        if: steps.modules.outputs.setup_code_server == 'true' || steps.modules.outputs.setup_git_ssh == 'true'
        id: credentials
        run: |
          TEMP_DIR=$(mktemp -d)

          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${{ inputs.target_user }}@${{ inputs.server_host }} bash <<'ENDSSH' > "$TEMP_DIR/output"
            # Extract only port and password from config
            CONFIG_PATH="$HOME/.config/code-server/config.yaml"
            if [ -f "$CONFIG_PATH" ]; then
              PORT=$(grep "bind-addr:" "$CONFIG_PATH" | awk -F: '{print $NF}' | tr -d ' ')
              PASSWORD=$(grep "password:" "$CONFIG_PATH" | awk -F: '{print $2}' | tr -d ' ')
              echo "CODE_SERVER_PORT=$PORT"
              echo "CODE_SERVER_PASSWORD=$PASSWORD"
            fi

            # Get SSH public key
            KEY_PATH="$HOME/.ssh/id_ed25519.pub"
            if [ -f "$KEY_PATH" ]; then
              echo "SSH_PUBLIC_KEY<<EOF"
              cat "$KEY_PATH"
              echo "EOF"
            fi
          ENDSSH

          # Parse output and set as masked outputs
          PORT=""
          PASSWORD=""
          SSH_KEY=""

          while IFS= read -r line; do
            if [[ "$line" =~ ^CODE_SERVER_PORT= ]]; then
              PORT=${line#*=}
              echo "port=$PORT" >> $GITHUB_OUTPUT
            elif [[ "$line" =~ ^CODE_SERVER_PASSWORD= ]]; then
              PASSWORD=${line#*=}
              echo "::add-mask::$PASSWORD"
              echo "password=$PASSWORD" >> $GITHUB_OUTPUT
            elif [[ "$line" == "SSH_PUBLIC_KEY<<EOF" ]]; then
              SSH_KEY=""
              while IFS= read -r keyline; do
                [[ "$keyline" == "EOF" ]] && break
                SSH_KEY+="$keyline"
              done
              echo "ssh_key=$SSH_KEY" >> $GITHUB_OUTPUT
            fi
          done < "$TEMP_DIR/output"

          # Validate we got the expected credentials
          if [[ "${{ steps.modules.outputs.setup_code_server }}" == "true" ]]; then
            if [[ -z "$PORT" || -z "$PASSWORD" ]]; then
              echo "::error::Failed to retrieve code-server credentials"
              echo "::error::Port: $PORT, Password: ${PASSWORD:+[set]}"
              exit 1
            fi
          fi

          if [[ "${{ steps.modules.outputs.setup_git_ssh }}" == "true" ]]; then
            if [[ -z "$SSH_KEY" ]]; then
              echo "::error::Failed to retrieve SSH public key"
              exit 1
            fi
          fi

          rm -rf "$TEMP_DIR"

      - name: Display setup summary
        if: steps.modules.outputs.setup_code_server == 'true' || steps.modules.outputs.setup_git_ssh == 'true'
        run: |
          echo "## ‚úÖ Setup Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Profile Used" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile:** ${{ inputs.setup_profile }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üë§ Configured User" >> $GITHUB_STEP_SUMMARY
          echo "- **User:** ${{ inputs.target_user }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.modules.outputs.setup_code_server }}" == "true" ]]; then
            echo "### üìã Code Server Configuration" >> $GITHUB_STEP_SUMMARY
            echo "- **Port:** ${{ steps.credentials.outputs.port }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Password:** \`${{ steps.credentials.outputs.password }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Access URL:** \`http://${{ inputs.server_host }}:${{ steps.credentials.outputs.port }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ steps.modules.outputs.setup_git_ssh }}" == "true" ]]; then
            echo "### üîë SSH Public Key" >> $GITHUB_STEP_SUMMARY
            echo "Add this to your Git hosting service (GitHub/GitLab/etc.):" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.credentials.outputs.ssh_key }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### ‚ö†Ô∏è Important Notes" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.modules.outputs.setup_code_server }}" == "true" ]]; then
            echo "- Save the code-server password in a secure location" >> $GITHUB_STEP_SUMMARY
            echo "- Code-server is running as: \`code-server@${{ inputs.target_user }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ steps.modules.outputs.setup_git_ssh }}" == "true" ]]; then
            echo "- The SSH private key remains on the server at \`~${{ inputs.target_user }}/.ssh/id_ed25519\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup
        if: always()
        run: |
          # Determine which user uploaded the scripts
          if [[ "${{ steps.validate.outputs.has_system_modules }}" == "true" ]]; then
            SSH_USER="${{ secrets.SUDO_ACCESS_USER }}"
          else
            SSH_USER="${{ inputs.target_user }}"
          fi

          # Clean up remote scripts first (while SSH key still exists)
          ssh -i ~/.ssh/deploy_key -p ${{ inputs.server_port }} ${SSH_USER}@${{ inputs.server_host }} "rm -f /tmp/foundry-*.sh" 2>/dev/null || true
          # Then clean up local deploy key
          rm -f ~/.ssh/deploy_key
